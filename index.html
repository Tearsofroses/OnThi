<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive MCQ Quiz</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link rel="stylesheet" href="styles.css?v=1.0.1">
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- JSZip for ZIP file handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- reCAPTCHA removed to avoid third-party cookies -->
</head>
<body>
    <div class="container">
        <header>
            <h1>Interactive MCQ Quiz</h1>
        </header>

        <!-- Input Section -->
        <div id="input-section" class="section">
            <h2>Setup Your Quiz</h2>
            
            <!-- Quiz Sessions -->
            <div id="sessions-section" class="saved-quizzes sessions-section">
                <h3>üìö My Quiz Sessions</h3>
                <div id="sessions-list" class="quiz-list sessions-container">
                    <p class="no-quizzes">No quiz sessions yet</p>
                </div>
            </div>
            
            <!-- Shared Quizzes -->
            <div id="shared-quizzes-section" class="saved-quizzes shared-section">
                <div class="section-header">
                    <h3>üåê Community Shared Quizzes</h3>
                    <button id="refresh-shared-btn" class="btn btn-small btn-secondary">üîÑ Refresh</button>
                </div>
                <div class="course-filter-section">
                    <label for="course-filter">Filter by Course:</label>
                    <select id="course-filter" class="course-filter-dropdown">
                        <option value="all">All Courses</option>
                    </select>
                </div>
                <div id="shared-quizzes-list" class="quiz-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                    <p class="no-quizzes">Loading community quizzes...</p>
                </div>
                <p class="share-info">üí° Click "üì§ Share to Community" to publish your quiz for everyone!<br>
                <small style="color: #666;">Other users need to click üîÑ Refresh to see new quizzes</small></p>
            </div>
            
            <div class="format-guide">
                <h3>Supported Formats:</h3>
                <div class="format-example">
                    <div class="format-header">
                        <strong>üìù Format 1: Compact Format (with answer key)</strong>
                        <div class="format-buttons">
                            <button id="copy-format-btn" class="btn-copy-format" title="Copy sample format">üìã Copy Sample</button>
                        </div>
                    </div>
                    <pre>1. (LO 1.1) Which of the following best describes the "Three-Schema Architecture"?

A. It separates the database into three physical files for redundancy.
B. It separates the user applications from the physical database to achieve data independence.
C. It divides users into three levels: Administrator, Designer, and End User.
D. It is a backup strategy involving three copies of data.

2. (LO 1.2) In the Relational Data Model, what is a "Relation" conceptually equivalent to?
A. A row in a file.
B. A pointer connecting two records.
C. A mathematical table of values using $R(X, Y, Z)$ notation.
D. A hierarchy of objects.</pre>
                    
                    <strong>Answer Key (at the end):</strong>
                    <pre>1B2C3A4B5C...</pre>
                    
                    <strong>üéì Format 2: Moodle/LMS HTML (includes answers!)</strong>
                    <p class="format-note" style="margin-top: 8px; margin-bottom: 8px;">
                        <strong>How to get the HTML:</strong>
                        <br>1. Open your Moodle quiz review page (with correct answers shown)
                        <br>2. Press <kbd>Ctrl+U</kbd> (Windows) or <kbd>Cmd+Option+U</kbd> (Mac) to view page source
                        <br>3. Press <kbd>Ctrl+A</kbd> to select all, then <kbd>Ctrl+C</kbd> to copy
                        <br>4. Paste the HTML here - it will automatically extract questions AND correct answers!
                        <br><strong>üí° For images:</strong> Use the Moodle Quiz Extractor above or run this bookmarklet on the quiz page first: <code>javascript:(async function(){const imgs=document.querySelectorAll('img');let count=0;for(let img of imgs){if(!img.src.startsWith('data:')){try{const r=await fetch(img.src);const b=await r.blob();const d=await new Promise(res=>{const rd=new FileReader();rd.onloadend=()=>res(rd.result);rd.readAsDataURL(b);});img.src=d;count++;}catch(e){}}}alert(\`Converted \${count} images to base64!\`);})();</code>
                    </p>
                    
                    <p class="format-note"><strong>üí° Note:</strong> LaTeX math notation like $\pi$, $\sigma$, $R(X,Y)$ is supported! Markdown formatting is also supported (**bold**, *italic*, `code`, [links](url)). HTML format automatically extracts correct answers from the page.</p>
                </div>
            </div>
            
            <!-- Moodle Quiz Auto-Extractor -->
            <div class="image-extraction-section">
                <div class="image-extraction-header">
                    <strong>üîê Moodle Quiz Auto-Extractor</strong>
                    <p class="extraction-hint">Extract quiz directly from Moodle with your credentials (100% client-side)</p>
                </div>
                
                <div class="extraction-step">
                    <div class="step-header">üéØ Automatic Extraction</div>
                    <p class="step-description">Extract quiz content from Moodle with all images and resources.</p>
                    
                    <div class="moodle-form">
                        <h3>üöÄ Moodle Quiz Extractor</h3>
                        <p class="form-hint">Extract quiz review pages from Moodle with all images and resources</p>
                        
                        <div class="form-group">
                            <label for="moodle-url">Quiz Review URL</label>
                            <input type="url" id="moodle-url" class="form-input" placeholder="https://moodle.example.edu/mod/quiz/review.php?attempt=12345" required>
                            <small class="form-hint">Paste the URL of the quiz REVIEW page (after completing the quiz)</small>
                        </div>

                        <div class="security-notice">
                            <strong>üí° EASIEST Method:</strong> Use the console code to create ONE self-contained HTML file!
                            <br><br>
                            <strong>4 Simple Steps:</strong><br>
                            1. Click "Generate Code" below<br>
                            2. A new tab opens ‚Üí Press <code>F12</code> for Console<br>
                            3. Press <code>Ctrl+V</code> to paste (already copied!)<br>
                            4. Press <code>Enter</code> ‚Üí Quiz downloads automatically!<br>
                            <br>
                            Then upload the downloaded HTML file using <strong>"üìÑ Upload HTML File"</strong> button above.
                        </div>

                        <div class="form-group">
                            <button id="extract-moodle-btn" class="btn-submit" style="width: 100%;">üìã Generate Extraction Code</button>
                        </div>

                        <div id="extraction-status" class="extraction-status"></div>
                    </div>
                    
                    <div class="security-notice" style="margin-top: 15px;">
                        <strong>üîê Privacy & Security:</strong>
                        <ul>
                            <li>‚úì All processing in your browser</li>
                            <li>‚úì No data sent to external servers</li>
                            <li>‚úì Open source - verify the code yourself</li>
                            <li>‚ö†Ô∏è Only use on trusted networks</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="upload-options-section" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <h3 style="color: white; margin: 0 0 15px 0; font-size: 18px; text-align: center;">üì• Upload Quiz File</h3>
                <div style="display: flex; justify-content: center;">
                    <label class="btn-submit" style="margin: 0; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px; background: white; color: #667eea; border-radius: 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <span style="font-size: 32px;">üìÑ</span>
                        <strong>Upload HTML File</strong>
                        <small style="opacity: 0.8; text-align: center;">Moodle quiz HTML only</small>
                        <input type="file" id="uploadHtmlFile" accept=".html,.htm" style="display: none;">
                    </label>
                </div>
            </div>
            
            <p style="text-align: center; margin: 20px 0 10px 0; color: #666;">Or paste your MCQ questions below:</p>
            
            <textarea id="quiz-input" placeholder="Paste your questions here..."></textarea>
            
            <div class="quiz-name-section">
                <label for="quiz-name-input">Quiz Name <span style="color: red;">*</span></label>
                <input type="text" id="quiz-name-input" placeholder="e.g., Database Management Final Exam" maxlength="100" required>
            </div>
            <div class="quiz-name-section">
                <label for="quiz-course-input">Course <span style="color: red;">*</span></label>
                <div class="course-input-group">
                    <input type="text" id="quiz-course-input" list="course-suggestions" placeholder="e.g., Software Engineering" maxlength="50" required>
                    <datalist id="course-suggestions"></datalist>
                </div>
            </div>
            <div class="quiz-name-section">
                <label for="quiz-timer-input">Time Limit (optional)</label>
                <div class="timer-input-group">
                    <input type="number" id="quiz-timer-input" placeholder="Minutes" min="1" max="999">
                    <span class="timer-hint">‚è±Ô∏è Leave empty for no time limit</span>
                </div>
            </div>
            
            <div class="input-actions">
                <button id="start-quiz-btn" class="btn btn-primary">Parse and Start Quiz</button>
                <button id="publish-quiz-btn" class="btn btn-success">üì§ Share to Community</button>
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="section hidden quiz-with-chat">
            <div class="quiz-main-content">
                <div class="quiz-header">
                    <button id="return-to-main-btn" class="btn-return" title="Return to Main Page">‚Üê Back</button>
                    <div class="progress-bar">
                        <div id="progress" class="progress-fill"></div>
                    </div>
                    <div class="quiz-header-info">
                        <p class="question-counter">Question <span id="current-q">1</span> of <span id="total-q">0</span></p>
                        <p class="timer-display">‚è±Ô∏è <span id="timer-display">0:00</span></p>
                        <p class="countdown-display hidden" id="countdown-display">‚è∞ Time Left: <span id="countdown-timer">--:--</span></p>
                    </div>
                </div>
            
            <div class="quiz-content-with-nav">
                <div class="quiz-question-area">
                    <div id="question-container">
                        <div id="question-text"></div>
                        <div id="options-container" class="options"></div>
                    </div>

                    <div class="quiz-controls">
                        <button id="prev-btn" class="btn btn-secondary" disabled>Previous</button>
                        <button id="next-btn" class="btn btn-primary">Next</button>
                        <button id="submit-btn" class="btn btn-success hidden">Submit Quiz</button>
                    </div>
                </div>
                
                <!-- Question Navigation Board -->
                <div class="question-nav-board">
                    <div class="nav-board-header">
                        <h4>Question Navigator</h4>
                        <button id="flag-current-btn" class="btn-flag" title="Flag/Unflag current question">
                            <span class="flag-icon">üö©</span>
                        </button>
                    </div>
                    <div class="nav-board-legend">
                        <div class="legend-item">
                            <span class="legend-box legend-answered"></span>
                            <span>Answered</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-box legend-flagged"></span>
                            <span>Flagged</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-box legend-current"></span>
                            <span>Current</span>
                        </div>
                    </div>
                    <div id="question-nav-grid" class="question-nav-grid">
                        <!-- Question buttons will be dynamically generated here -->
                    </div>
                </div>
            </div>
            </div>
        </div>

        </div>
        <div id="results-section" class="section hidden">
            <div class="results-main-content">
            <h2>Quiz Results</h2>
            <div class="score-summary">
                <div class="score-circle">
                    <span id="score-percentage">0%</span>
                </div>
                <p class="score-text">You scored <span id="score">0</span> out of <span id="total">0</span></p>
            </div>
            
            <h3>Review Your Answers</h3>
            <div id="review-container"></div>
            
            <div class="result-actions">
                <button id="restart-btn" class="btn btn-primary">Take New Quiz</button>
            </div>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- MVC Architecture -->
    <script src="models.js?v=1.0.5"></script>
    <script src="views.js?v=1.0.4"></script>
    <script src="controllers.js?v=1.1.0"></script>
    <script src="app.js?v=1.0.2"></script>
</body>
</html>
